<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>noVNC WebSocket Test</title>
    <style>
        html, body, #noVNC_container { height: 100%; margin: 0; padding: 0; }
        #noVNC_container { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
<div id="noVNC_container"></div>
<script src="https://cdn.jsdelivr.net/npm/@novnc/novnc@1.4.0/dist/novnc.min.js"></script>
<script>
    // Nur userId angeben, Port wird automatisch ermittelt
    const userId = 1; // <-- HIER die User-ID anpassen!
    let password = "password123"; // Optional: Passwort kann auch aus der API kommen

    // Hole Live-Environment für den User
    fetch(`/api/live-environments/${userId}`)
        .then(response => response.json())
        .then(env => {
            if (!env || !env.vncPort) {
                alert('Kein VNC-Port für diesen User gefunden!');
                return;
            }
            const vncPort = env.vncPort;
            if (env.vncPassword) password = env.vncPassword;
            const wsUrl = `ws://${window.location.hostname}:9090/ws/novnc?vncPort=${vncPort}`;
            if (window.RFB) {
                const rfb = new window.RFB(document.getElementById('noVNC_container'), wsUrl, {
                    credentials: { password: password }
                });
                rfb.viewOnly = false;
                rfb.scaleViewport = true;
                rfb.background = '#222';
                rfb.addEventListener('connect', () => {
                    console.log('Verbunden mit VNC über WebSocket!');
                });
                rfb.addEventListener('disconnect', (e) => {
                    alert('Verbindung getrennt: ' + (e.detail.clean ? 'Normal' : 'Fehler'));
                });
            } else {
                alert('noVNC konnte nicht geladen werden!');
            }
        })
        .catch(err => {
            alert('Fehler beim Laden des Live-Environment: ' + err);
        });
</script>
</body>
</html>
